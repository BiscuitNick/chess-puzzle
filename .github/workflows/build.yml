name: Build Game

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'dev'

env:
  GODOT_VERSION: 4.5.1
  EXPORT_NAME: chess-puzzle
  STOCKFISH_VERSION: stockfish-ubuntu-x86-64-avx2

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: Windows Desktop
            output: chess-puzzle.exe
            artifact: windows
            stockfish_asset: stockfish-windows-x86-64-avx2.zip
            stockfish_binary: stockfish/stockfish-windows-x86-64-avx2.exe
            stockfish_dest: stockfish.exe
          - platform: Linux
            output: chess-puzzle.x86_64
            artifact: linux
            stockfish_asset: stockfish-ubuntu-x86-64-avx2.tar
            stockfish_binary: stockfish/stockfish-ubuntu-x86-64-avx2
            stockfish_dest: stockfish
          - platform: macOS
            output: chess-puzzle.app
            artifact: macos
            stockfish_asset: stockfish-macos-x86-64-avx2.tar
            stockfish_binary: stockfish/stockfish-macos-x86-64-avx2
            stockfish_dest: stockfish

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Download Stockfish
        run: |
          # Download latest Stockfish release
          STOCKFISH_URL="https://github.com/official-stockfish/Stockfish/releases/latest/download/${{ matrix.stockfish_asset }}"
          echo "Downloading Stockfish from: $STOCKFISH_URL"
          curl -L -o stockfish-archive "$STOCKFISH_URL"

          # Extract based on file type
          if [[ "${{ matrix.stockfish_asset }}" == *.zip ]]; then
            unzip stockfish-archive
          else
            tar -xf stockfish-archive
          fi

          # Create destination directory and copy binary
          mkdir -p bin/stockfish/${{ matrix.artifact }}
          cp "${{ matrix.stockfish_binary }}" "bin/stockfish/${{ matrix.artifact }}/${{ matrix.stockfish_dest }}"
          chmod +x "bin/stockfish/${{ matrix.artifact }}/${{ matrix.stockfish_dest }}"

          echo "Stockfish binary:"
          ls -la bin/stockfish/${{ matrix.artifact }}/

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Verify Godot installation
        run: |
          godot --version
          echo "Export templates location:"
          ls -la ~/.local/share/godot/export_templates/ || true

      - name: Import project
        run: |
          godot --headless --import

      - name: Create build directory
        run: mkdir -p builds/${{ matrix.artifact }}

      - name: Build ${{ matrix.platform }}
        run: |
          godot --headless --export-release "${{ matrix.platform }}" builds/${{ matrix.artifact }}/${{ matrix.output }}

      - name: Copy Stockfish binary to build
        run: |
          if [ "${{ matrix.platform }}" = "macOS" ]; then
            # macOS app bundle structure
            mkdir -p "builds/${{ matrix.artifact }}/${{ matrix.output }}/Contents/MacOS/bin/stockfish/${{ matrix.artifact }}"
            cp "bin/stockfish/${{ matrix.artifact }}/${{ matrix.stockfish_dest }}" \
               "builds/${{ matrix.artifact }}/${{ matrix.output }}/Contents/MacOS/bin/stockfish/${{ matrix.artifact }}/"
            chmod +x "builds/${{ matrix.artifact }}/${{ matrix.output }}/Contents/MacOS/bin/stockfish/${{ matrix.artifact }}/${{ matrix.stockfish_dest }}"
          else
            # Windows/Linux flat structure
            mkdir -p "builds/${{ matrix.artifact }}/bin/stockfish/${{ matrix.artifact }}"
            cp "bin/stockfish/${{ matrix.artifact }}/${{ matrix.stockfish_dest }}" \
               "builds/${{ matrix.artifact }}/bin/stockfish/${{ matrix.artifact }}/"
            chmod +x "builds/${{ matrix.artifact }}/bin/stockfish/${{ matrix.artifact }}/${{ matrix.stockfish_dest }}" || true
          fi

          echo "Build contents:"
          find builds/${{ matrix.artifact }} -type f | head -20

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.EXPORT_NAME }}-${{ matrix.artifact }}
          path: builds/${{ matrix.artifact }}
          retention-days: 14

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release packages
        run: |
          cd artifacts

          # Windows ZIP
          cd chess-puzzle-windows
          zip -r ../chess-puzzle-windows.zip .
          cd ..

          # Linux tar.gz
          cd chess-puzzle-linux
          tar -czvf ../chess-puzzle-linux.tar.gz .
          cd ..

          # macOS ZIP
          cd chess-puzzle-macos
          zip -r ../chess-puzzle-macos.zip .
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/chess-puzzle-windows.zip
            artifacts/chess-puzzle-linux.tar.gz
            artifacts/chess-puzzle-macos.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
